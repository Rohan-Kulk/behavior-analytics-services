You can install cluster logging by deploying the Elasticsearch and Cluster Logging Operators. The Elasticsearch Operator creates and manages the Elasticsearch cluster used by cluster logging. The Cluster Logging Operator creates and manages the components of the logging stack.

The process for deploying cluster logging to OpenShift Container Platform involves:
-  Installing Cluster Logging Operator   
-  Installing the Elasticsearch Operator 

#### Installing cluster logging

Prerequisites

-   Ensure that you have the necessary persistent storage for Elasticsearch. Note that each Elasticsearch node requires its own storage volume.
    
    Elasticsearch is a memory-intensive application. By default, OpenShift Container Platform installs three Elasticsearch nodes with memory requests and limits of 16 GB. This initial set of three OpenShift Container Platform nodes might not have enough memory to run Elasticsearch within your cluster. If you experience memory issues that are related to Elasticsearch, you should add more Elasticsearch nodes to your cluster rather than increasing the memory on exiting nodes.

##### Steps 
Execute below steps to install the Elasticsearch Operator and Cluster Logging Operator using the CLI:

1. Create a Namespace for the Elasticsearch Operator.
a. Create a Namespace object YAML file for the Elasticsearch Operator:. 
```execute
cat <<'EOF'>eo-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-operators-redhat 
  annotations:
    openshift.io/node-selector: ""
  labels:
    openshift.io/cluster-monitoring: "true" 
EOF    
```
b. Create the Namespace: 
```execute
oc create -f eo-namespace.yaml
```
2. Create a Namespace for the Cluster Logging Operator:
a.   Create a Namespace object YAML file for the Cluster Logging Operator:
```execute
cat <<'EOF'> clo-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-logging 
  annotations:
    openshift.io/node-selector: ""
  labels:
    openshift.io/cluster-monitoring: "true" 
EOF    
```
 b. Create the Namespace:
```execute
oc create -f clo-namespace.yaml
```
3. Install the Elasticsearch Operator by creating the following objects:
a. Create an Operator Group object YAML file for the Elasticsearch operator:
```execute
cat <<'EOF'>eo-og.yaml
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: openshift-operators-redhat
  namespace: openshift-operators-redhat 
spec: {}
EOF
```
b. Create an Operator Group object:
```execute
oc create -f eo-og.yaml
```
c. Create a Subscription object YAML file to subscribe a Namespace to the Elasticsearch Operator.
```execute
cat <<'EOF'>eo-sub.yaml
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: "elasticsearch-operator"
  namespace: "openshift-operators-redhat" 
spec:
  channel: "4.3" 
  installPlanApproval: "Automatic"
  source: "redhat-operators" 
  sourceNamespace: "openshift-marketplace"
  name: "elasticsearch-operator"
EOF
```
  d. Create the Subscription object:
```execute
oc create -f eo-sub.yaml
```
e. Verify the Operator installation, there should be an Elasticsearch Operator in each Namespace.:
```execute
oc get csv --all-namespaces
```
Output:
```NAMESPACE                              NAME                                            DISPLAY                             VERSION                  REPLACES                    PHASE
ibm-cert-store                         elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0                               
openshift-cluster-samples-operator     elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0                               
openshift-cluster-storage-operator     elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0                               
openshift-dns                          elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0                               
openshift-operator-lifecycle-manager   packageserver                                   Package Server                      0.13.0                                               Succeeded
openshift-operators-redhat             elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0                               Succeeded
openshift-operators                    elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator              4.3.37-202009151447.p0 
```

4. Install the Cluster Logging Operator by creating the following objects:
a. Create an OperatorGroup object YAML file for the Cluster Logging Operator:
```execute
cat <<'EOF'>clo-og.yaml
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: cluster-logging
  namespace: openshift-logging 
spec:
  targetNamespaces:
  - openshift-logging 
EOF
```
b.Create the OperatorGroup object:
```execute
oc create -f clo-og.yaml
```
c.Create a Subscription object YAML file to subscribe a Namespace to the Cluster Logging Operator.

```execute
cat <<'EOF'>clo-sub.yaml
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: cluster-logging
  namespace: openshift-logging
spec:
  channel: "4.3"
  name: cluster-logging
  source: redhat-operators
  sourceNamespace: openshift-marketplace
EOF
```
d. Create the Subscription object:
```execute
oc create -f clo-sub.yaml
```
e. Verify the Operator installation.
There should be a Cluster Logging Operator in the `openshift-logging` Namespace. The Version number might be different than shown.

```execute
oc get csv -n openshift-logging
```
Output:

```
NAME                                            DISPLAY                  VERSION                  REPLACES   PHASE
clusterlogging.4.3.37-202009151447.p0           Cluster Logging          4.3.37-202009151447.p0              Succeeded
elasticsearch-operator.4.3.37-202009151447.p0   Elasticsearch Operator   4.3.37-202009151447.p0              Succeeded
```
5. Create a Cluster Logging instance:
a. Create an instance object YAML file for the Cluster Logging Operator:
```execute
cat <<'EOF'>clo-instance.yaml
apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogging"
metadata:
  name: "instance" 
  namespace: "openshift-logging"
spec:
  managementState: "Managed"  
  logStore:
    type: "elasticsearch"  
    elasticsearch:
      nodeCount: 1 
      storage:
        storageClassName: "default" 
        size: 20G
      redundancyPolicy: "ZeroRedundancy"
  visualization:
    type: "kibana"  
    kibana:
      replicas: 1
  curation:
    type: "curator"  
    curator:
      schedule: "30 3 * * *"
  collection:
    logs:
      type: "fluentd"  
      fluentd: {}
EOF
```

b. Create the instance:
```execute
oc create -f clo-instance.yaml
```
6. Verify the install by listing the Pods in the **openshift-logging** project.
You should see several Pods for Cluster Logging, Elasticsearch, Fluentd, and Kibana similar to the following list:
```execute
oc get pods -n openshift-logging
```
Output:

```
NAME                                            READY   STATUS    RESTARTS   AGE
cluster-logging-operator-66f77ffccb-ppzbg       1/1     Running   0          7m
elasticsearch-cdm-ftuhduuw-1-ffc4b9566-q6bhp    2/2     Running   0          2m40s
elasticsearch-cdm-ftuhduuw-2-7b4994dbfc-rd2gc   2/2     Running   0          2m36s
fluentd-587vb                                   1/1     Running   0          2m26s
fluentd-7mpb9                                   1/1     Running   0          2m30s
kibana-d6d5668c5-rppqm                          2/2     Running   0          2m39s
```

7. Get Kibana Dashboard URL:

```execute
kibana_dahboard_url=https://$(oc get routes -n openshift-logging |awk 'NR==2 {print $2}')
echo $kibana_dahboard_url
```
